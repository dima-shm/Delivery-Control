@{
    ViewBag.Title = "DelControl";
}

@if (!User.Identity.IsAuthenticated)
{
    <div class="row">
        <div class="col-md-12">
            <h3>Управляйте мобильными ресурсами эффективно</h3>
        </div>
        <div class="col-md-6">
            <div class="form-horizontal">
                <div>
                    <h4>GPS контроль</h4>
                    <span>Местонахождение онлайн, ситуационный контроль</span>

                    <h4>Мобильные приложения</h4>
                    <span>Для выездных сотрудников и водителей</span>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-horizontal">
                <h4>Рабочие задания</h4>
                <span>Планируйте задачи и координируйте работу мобильного персонала онлайн</span>

                <h4>Автоматизация процессов</h4>
                <span>Интегрируйте сервис DelControl с корпоративными IT-системами и сайтом</span>
            </div>
        </div>
    </div>
}
else
{
    <script src="http://maps.google.com/maps/api/js?key=AIzaSyBlHNvzhC5Qhu0FqWbD03QDVBGUkgF7_UE" type="text/javascript"></script>
    <style>
        .infoWindow {
            height: 150px;
            width: 250px;
        }
    </style>
    <div class="row">
        <div class="col-md-8">
            <div id="google_map" style="height:400px; width:100%; margin-bottom:20px; border-radius:5px"></div>
        </div>
        <div class="col-md-4">
            <div id="couriers_list" style="height:400px; overflow: auto;"></div>
        </div>
    </div>
}

@section scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            GetMap();
        });
        function GetMap() {
            var mapOptions = {
                zoom: 11,
                center: new google.maps.LatLng(53.904539799999995, 27.5615244),
                mapTypeId: google.maps.MapTypeId.G_NORMAL_MAP,
            };
            var map = new google.maps.Map(document.getElementById("google_map"), mapOptions);
            var mapMarkers = {};
            var activeInfoWindow;
            $.getJSON('@Url.Action("", "api/LastCourierLocations")', function (data) {
                $.each(data, function (i, item) {
                    $("#couriers_list").append("<a href='#' data-id='" + item.CourierId + "'>" + item.CourierId + "</a><hr />");
                    var marker = new google.maps.Marker({
                        'position': new google.maps.LatLng(item.Latitude, item.Longitude),
                        'map': map,
                        'icon': 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    });
                    var infowindow = new google.maps.InfoWindow({
                        content: "<div class='infoWindow'>" +
                            "<h6>CourierId: " + item.CourierId + "</h6><br />" +
                            "<h8>Speed: " + item.Speed + "</h8><br />" +
                            "<h8>Time: " + item.Time + "</h8>"
                    });
                    google.maps.event.addListener(marker, 'click', function () {
                        activeInfoWindow && activeInfoWindow.close();
                        infowindow.open(map, marker);
                        activeInfoWindow = infowindow;
                    });
                    mapMarkers[item.CourierId] = marker;
                });
                $('#couriers_list a').click(function () {
                    var link = $(this).data('id');
                    var marker = mapMarkers[link];
                    if (marker) {
                        google.maps.event.trigger(marker, "click");
                    }
                });
            });
        }
    </script>
}
